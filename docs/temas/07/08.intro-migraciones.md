# 8. Introducci贸n a las migraciones

En esta 7陋 lecci贸n vamos a ver c贸mo podemos utilizar las migraciones en Laravel.

### Recursos

- [Documentaci贸n oficial de Laravel - Migraciones](https://laravel.com/docs/11.x/migrations)

---

## Migraciones

Si revisamos el c贸digo del 煤ltimo episodio vemos que las notas est谩n `hardcoded` dentro de la clase de `Note` y que si queremos agregar una nueva nota o modificar una existente, tendr铆amos que hacerlo manualmente. Esto no es la soluci贸n m谩s 贸ptima, lo mejor ser铆a tener una base de datos donde almacenar las notas.

En el proyecto anterior, ten铆amos una base de datos SQLite, con una tabla `notes` que ten铆a 3 campos: `id`, `title` y `body`. Esta tabla la hab铆amos creado manualmente a trav茅s de un Script, y si quer铆amos modificarla, ten铆amos que hacerlo manualmente tambi茅n, agregando o eliminando campos. Este proceso no est谩 mal, pero el problema es que no es repetible, y si queremos compartir la base de datos con otros desarrolladores, tendr铆amos que compartir el script, y asegurarnos de que todos los desarrolladores lo ejecuten correctamente. Tambi茅n si queremos hacer un rollback (volver atr谩s) en la base de datos, tendr铆amos que hacerlo manualmente.
Por supesto, tambi茅n si lo subimos a un servidor de producci贸n, tendr铆amos que recrear los datos manualmente a a trav茅s de un script, todo esto es un proceso tedioso y propenso a errores.

Para solucionar este problema, Laravel nos proporciona las **migraciones**, que son una forma de definir la estructura de la base de datos a trav茅s de c贸digo, y que se pueden compartir con otros desarrolladores, y que se pueden ejecutar en cualquier entorno, sin tener que preocuparnos de si la base de datos existe o no, o si los datos est谩n creados o no.

**驴Donde est谩n ubicados la informaci贸n de migraciones en Laravel?**

Toda la informaci贸n y ficheros sobre BD en Laravel se encuentran en el directorio `database`.

Para las migraciones, se encuentran en el directorio `database/migrations`.

Si revisamos el directorio `database/migrations`, veremos que existen ya una serie de migraciones, cada una con un nombre y una fecha, y que contienen un fichero PHP con una serie de pasos para modificar la BD. Es como un script, pero en PHP.

Como estamos utilizando SQLite, Laravel nos proporciona un fichero de base de datos `database/database.sqlite`, que es donde se almacenan los datos. Puede ser que esta fichero no exista, en cuyo caso, Laravel lo crear谩 autom谩ticamente. (Si por alg煤n motivo no se crea, puedes crearlo manualmente).

**Datos de configuraci贸n**

Todos los datos de configuraci贸n en Laravel se encuentran dentro de un fichero `.env`, que se encuentra en la ra铆z del proyecto. En este fichero se encuentran todas las variables de entorno, como la conexi贸n a la base de datos, el nombre de la base de datos, el usuario, la contrase帽a, etc.

Laravel utiliza por defecto SQLite, pero si quieres utilizar otro motor de base de datos, simplemente cambia la variable `DB_CONNECTION` a `mysql`, `pgsql`, `sqlsrv`, etc. y configura el resto de variables de entorno.

>  Para SQLite, simplemente deja la variable `DB_CONNECTION` como `sqlite`, y el resto de variables de entorno como est谩n.

Los datos de configuraci贸n relacionados con la BD en el fichero `.env` son:

- `DB_CONNECTION`: Tipo de conexi贸n a la base de datos. Por defecto, `sqlite`.
- `DB_DATABASE`: Nombre de la base de datos.
- `DB_USERNAME`: Usuario de la base de datos.
- `DB_PASSWORD`: Contrase帽a de la base de datos.
- `DB_HOST`: Host de la base de datos.
- `DB_PORT`: Puerto de la base de datos.


Otras variables de entorno interesantes son:

- `APP_NAME`: Nombre de la aplicaci贸n.
- `APP_ENV`: Entorno de la aplicaci贸n. Por defecto, `local`. Puede ser `production`, `testing`, etc.
- `APP_DEBUG`: Modo de depuraci贸n. Por defecto, `true`.
- `APP_URL`: URL de la aplicaci贸n.
- `APP_KEY`: Clave de la aplicaci贸n. Generada autom谩ticamente con `php artisan key:generate`.
- `LOG_CHANNEL`: Canal de logs. Por defecto, `stack`. Puede ser `single`, `daily`, etc.
- `LOG_LEVEL`: Nivel de logs. Por defecto, `debug`. Puede ser `info`, `notice`, `warning`, `error`, `critical`, `alert`, `emergency`.

>  Puedes ver m谩s informaci贸n sobre las variables de entorno en la [documentaci贸n oficial](https://laravel.com/docs/8.x/configuration#environment-configuration).

Variables sobre sesiones y cach茅:

- `SESSION_DRIVER`: Driver de sesiones. Por defecto, `file`. Puede ser `cookie`, `database`, `apc`, `memcached`, `redis`, etc.
- `SESSION_LIFETIME`: Duraci贸n de la sesi贸n en minutos. Por defecto, `120`.
- `SESSION_ENCRYPT`: Encriptaci贸n de la sesi贸n. Por defecto, `false`.
- `SESSION_DOMAIN`: Dominio de la sesi贸n.
- `SESSION_PATH`: Ruta de la sesi贸n.
- `SESSION_SECURE_COOKIE`: Cookie segura. Por defecto, `false`.


### php artisan

Laravel nos proporciona una serie de comandos a trav茅s de la consola, que nos permiten realizar tareas comunes, como crear controladores, modelos, migraciones, seeders, etc.

Para ver todos los comandos disponibles, simplemente ejecuta el comando `php artisan` en la consola.

```bash	
php artisan
```

Los comandos m谩s importante son:

- `php artisan make:controller`: Crea un controlador.
- `php artisan make:model`: Crea un modelo.
- `php artisan make:migration`: Crea una migraci贸n.
- `php artisan make:seeder`: Crea un seeder.

>  Puedes ver m谩s informaci贸n sobre los comandos disponibles en la [documentaci贸n oficial](https://laravel.com/docs/8.x/artisan).

Tambi茅n es posible ver informaci贸n sobre la Base de Datos a trav茅s de la consola, con el comando `php artisan db:show`.

### Crear una migraci贸n

Para crear una migraci贸n, simplemente ejecuta el comando `php artisan make:migration` seguido del nombre de la migraci贸n. Laravel crear谩 un fichero de migraci贸n en el directorio `database/migrations`.

Una migraci贸n consta de dos m茅todos: `up()` y `down()`. El m茅todo `up()` se ejecuta cuando se ejecuta la migraci贸n, y el m茅todo `down()` se cuando al hacer un rollback.

Si revisamos la migraci贸n `0001_01_01_000000_create_users_table.php`, encargada de crear la tabla de usuarios, vemos que en el m茅todo `up()` se crea la tabla `users`, y en el m茅todo `down()` se elimina la tabla `users`.

```php
public function up(): void {
    Schema::create('users', function (Blueprint $table) {
        $table->id();
        $table->string('name');
        $table->string('email')->unique();
        $table->timestamp('email_verified_at')->nullable();
        $table->string('password');
        $table->rememberToken();
        $table->timestamps();
    });

    Schema::create('password_reset_tokens', function (Blueprint $table) {
        $table->string('email')->primary();
        $table->string('token');
        $table->timestamp('created_at')->nullable();
    });

    Schema::create('sessions', function (Blueprint $table) {
        $table->string('id')->primary();
        $table->foreignId('user_id')->nullable()->index();
        $table->string('ip_address', 45)->nullable();
        $table->text('user_agent')->nullable();
        $table->longText('payload');
        $table->integer('last_activity')->index();
    });
}
```

Si analizamos el c贸digo, vemos que se crean 3 tablas: `users`, `password_reset_tokens` y `sessions`, con sus respectivos campos.

La funci贸n `Schema::create()` se encarga de crear la tabla, y recibe como primer par谩metro el nombre de la tabla, y como segundo par谩metro una funci贸n an贸nima con un objeto `Blueprint` que se encarga de definir los campos de la tabla.

Para cada tipo de campo, Lavavel nos proporciona un m茅todo en el objeto `Blueprint`, como `id()`, `string()`, `timestamp()`, `rememberToken()`, etc. que se encargan de definir el tipo de campo. Los campos tambi茅n pueden tener modificadores, como `unique()`, `nullable()`, `index()`, etc. Estos modificadores se encadenan al m茅todo del campo, y se pueden encadenar varios modificadores.

En el m茅todo `down()`, simplemente se eliminan las tablas creadas en el m茅todo `up()`, con la funci贸n `Schema::drop()`.

```php
public function down(): void {
    Schema::dropIfExists('users');
    Schema::dropIfExists('password_reset_tokens');
    Schema::dropIfExists('sessions');
}
```	

**Campos de tiempo**

Los campos de tiempo, como `created_at` y `updated_at`, se crean autom谩ticamente si se llama al m茅todo `timestamps()`. Estos campos los actualiza autom谩ticamente Laravel, y se utilizan para saber cu谩ndo se cre贸 y se actualiz贸 un registro.

### Ejecutar una migraci贸n

Si queremos ejecutar una migraci贸n, simplemente ejecutamos el comando `php artisan migrate` en la consola. El control de las migraciones aplicadas se realiza a trav茅s de una tabla llamada `migrations`, que se crea autom谩ticamente al ejecutar la primera migraci贸n.

Esta tabla, tiene un campo `migration`, que es el nombre de la migraci贸n, y un campo `batch`, que es el n煤mero de la tanda de migraciones. En el campo `batch` indica el orden de c贸mo deben ejecutarse las migraciones. Si 2 o m谩s migraciones tienen el mismo n煤mero de `batch`, se ejecutar谩n en paralelo, es decir, que si hacemos un rollback, se har谩 un rollback de todas las migraciones con el mismo n煤mero de `batch`.

>  Puedes ver m谩s informaci贸n sobre las migraciones en la [documentaci贸n oficial](https://laravel.com/docs/11.x/migrations).


Adem谩s de `php artisan migrate`, existen otros comandos relacionados con las migraciones:

- `php artisan migrate:fresh`: Borrar todas las tablas de la BD (sin ejecutar rollback) y ejecuta todas las migraciones.
- `php artisan migrate:refresh`: Hace un rollback de todas las migraciones y las vuelve a ejecutar. Si se desea volver a rellenar la BD con datos de prueba, se puede utilizar el flag `--seed`.
- `php artisan migrate:install`: Instala la tabla de migraciones.
- `php artisan migrate:reset`: Hace un rollback de todas las migraciones.
- `php artisan migrate:rollback`: Hace un rollback de la 煤ltima migraci贸n.
- `php artisan migrate:status`: Muestra el estado de las migraciones.


## Crear migraci贸n para la tabla de notas

Vamos a crear una migraci贸n para la tabla de notas. Para ello, simplemente ejecuta el comando `php artisan make:migration create_notes_table` en la consola. La convenci贸n de nombres en Laravel es `create_<nombre>_table`, donde `<nombre>` es el nombre de la tabla en plural.

>  Si no le indicamos un nombre de migraci贸n, nos lo preguntar谩 de forma interactiva.

Como resultado, se crear谩 un fichero de migraci贸n en el directorio `database/migrations` con el nombre `YYYY_MM_DD_HHMMSS_create_notes_table.php`.

El nombre el fichero, la primera parte est谩 compuesta de la fecha y la hora en la que se cre贸 la migraci贸n, y la segunda parte es el nombre de la migraci贸n. `YYYY` es el a帽o, `MM` es el mes, `DD` es el d铆a, `HH` es la hora, `MM` es el minuto y `SS` es el segundo.

Ahora vamos al fichero de migraci贸n y definimos los campos de la tabla de notas.

```php
public function up(): void {
    Schema::create('notes', function (Blueprint $table) {
        $table->id(); //Campo de clave primaria, por defecto es un entero autoincremental
        $table->string('title', 255);  //Campo de texto con 255 caracteres de longitud
        $table->text('body'); //Campo de texto
        $table->timestamps();
    });
}
```
Una vez definidos los campos, simplemente ejecutamos la migraci贸n con el comando `php artisan migrate`, y ejecutar谩 las migraciones pendientes, es decir, aquellas que no est茅n incluidas en la tabla `migrations`.

```bash
php artisan migrate
```
Y ahora si revisamos la base de datos, veremos que se ha creado la tabla `notes` con los campos `id`, `title`, `body`, `created_at` y `updated_at`.

Ahora si queremos hacer un rollback, simplemente ejecutamos el comando `php artisan migrate:rollback`, y har谩 un rollback de la 煤ltima migraci贸n.

```bash
php artisan migrate:rollback
```
Y la tabla `notes` se habr谩 eliminado.


!!! info "Alguna duda?"
    puedes ver el siguiente [video](https://laracasts.com/series/30-days-to-learn-laravel-11/episodes/8) que explica estos pasos con m谩s detalle.
