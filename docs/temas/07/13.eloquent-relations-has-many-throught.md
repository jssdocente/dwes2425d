# 13. Eloquent: Relaci贸n Has Many Through

En esta 13陋 lecci贸n vamos a ver c贸mo podemos utilizar la relaci贸n `Has Many Through` en Eloquent, para relacionar los modelos entre s铆.

### Recursos

- [Eloquent Relaci贸n Has-Many-Throught](https://laravel.com/docs/11.x/eloquent-relationships#has-many-through)

---

## Relaci贸n Has Many Through

La relaci贸n `Has Many Through` nos permite una forma de acceder a tablas lejanas, que no est谩n directamente relacionadas entre s铆. Por ejemplo, Un `Editor` tiene muchos `Post`, y un `Post` tiene muchos `Comment`. Si queremos acceder a los `Comment` de un `Editor`, podemos hacerlo a trav茅s de la relaci贸n `Has Many Through`.

En nuestra aplicaci贸n de Notas, un usuario tiene muchas notas, y una nota tiene muchos comentarios. Si queremos acceder a todos los  comentarios realizados por un usuario, podemos hacerlo a trav茅s de la relaci贸n `Has Many Through`.

## Crear tabla Comments

Actualmente en nuestra aplicaci贸n de Notas, no tenemos comentarios. Vamos a crear una tabla `comments` para almacenar los comentarios de las notas. Adem谩s vamos a crear una migraci贸n, un modelo y un factory para la tabla `comments`.

```bash
php artisan make:model Comment -mf
```

Ahora vamos en la migraci贸n, tenemos que crear lo siguiente:

- Tabla Comments
  - id
  - body
  - nota_id (clave for谩nea, y con cascada-eliminar)

En el modelo `Note`, tenemos que a帽adir la relaci贸n `hasMany()` con el modelo `Comment`.

En el modelo `Comment`, tenemos que a帽adir la relaci贸n `belongsTo()` con el modelo `Note`.

**Implementa estos cambios y ejecuta las migraciones.**

Tambi茅n rellena el factory `CommentFactory` con los campos necesarios.

```php
class CommentFactory extends Factory
{
    public function definition(): array
    {
        return [
            'body' => fake()->words(10, true),
            // selecciona una nota aleatoria
            'note_id' => Note::inRandomOrder()->first()->id,
        ];
    }
}
```

Ahora a trav茅s de tinker, crea varios comentarios.

```bash
php artisan tinker

App\Models\Comment::factory()->count(10)->create();
```

## Crear una relaci贸n Has Many Through

Para crear una relaci贸n `Has Many Through` en Eloquent, simplemente a帽adimos un m茅todo en el modelo que representa la relaci贸n.

Por ejemplo, si queremos relacionar la tabla `users` con la tabla `comments`, a trav茅s de la tabla `notes`, simplemente a帽adimos un m茅todo `comments()` en el modelo `User`.

El m茅todo `hasManyThrough()` recibe 2 par谩metros, el modelo al que queremos acceder, y el modelo intermedio.

Y como estamos utilizando las convecciones de llaves for谩neas de Laravel, no necesitamos especificar las claves for谩neas, ya que Eloquent las detecta autom谩ticamente.

```php
class User extends Model
{
    public function comments()
    {
        return $this->hasManyThrough(Comment::class, Note::class);
    }
}
```

Para probarlo, vamos a tinker y a acceder a los comentarios de un usuario.

```bash
php artisan tinker
```

>  Revisa la nota asociada a los comentarios creados, y anota el user_id de las mismas. Utiliza ese user_id para probar en Tinker.

```php
$user = App\Models\User::find(1);

$user->comments;
= Illuminate\Database\Eloquent\Collection {#5223
    all: [
      App\Models\Comment {#6272
        id: 1,
        body: "dicta a id eum sequi ad expedita rerum dolorum aut",
        note_id: 6,
        created_at: "2024-12-25 20:38:53",
        updated_at: "2024-12-25 20:38:53",
        laravel_through_key: 21,
      },
      App\Models\Comment {#6007
        id: 2,
        body: "earum similique iste quasi delectus optio laudantium dolores consequuntur quia",
        note_id: 6,
        created_at: "2024-12-25 20:39:00",
        updated_at: "2024-12-25 20:39:00",
        laravel_through_key: 21,
      },
    ],
  }
```

Con esto hemos creado una relaci贸n `Has Many Through` en Eloquent, y hemos accedido a los comentarios de un usuario a trav茅s de las notas.

