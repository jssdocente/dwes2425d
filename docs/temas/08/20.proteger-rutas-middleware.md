# 20. Proteger rutas con Middleware

En esta 20陋 lecci贸n, vamos a ver c贸mo proteger las rutas de nuestra aplicaci贸n, para que solo puedan ser accedidas por usuarios autenticados. Laravel nos proporciona una serie de clases y m茅todos que nos facilitan la protecci贸n de las rutas.

### Recursos

- [Middlewares](https://laravel.com/docs/11.x/middleware)

## Middleware

Los middlewares son una capa intermedia entre la petici贸n y la respuesta de nuestra aplicaci贸n. Laravel nos proporciona una serie de middlewares de forma predeterminada, y tambi茅n nos permite crear nuestros propios middlewares.

En t茅rminos sencillos tenemos lo siguiente: Un middleware altera el flujo, este puede devolver la respuesta deseada o una redirecci贸n a una p谩gina de error, mensaje o estado HTTP.

### Crear un Middleware

Para crear un middleware, podemos utilizar el comando `make:middleware` de Artisan. Este comando crear谩 un nuevo archivo en la carpeta `app/Http/Middleware`.

Imaginemos que tenemos una funcionalidad, que solo queremos que ciertas rutas sean accedidas si ese usuario est谩 subscrito a un plan de pago. Vamos a crear un middleware llamado `Subscribed`.

```bash
php artisan make:middleware Subscribed
```
Esto nos crear谩 un archivo llamado `Subscribed.php` en la carpeta `app/Http/Middleware`.

Los middlewares tienen un 煤nico m茅todo llamado `handle`, que recibe una petici贸n y una funci贸n para llamar como continuaci贸n si todo va ok. En este m茅todo, podemos realizar cualquier verificaci贸n que necesitemos, y si la verificaci贸n falla, podemos devolver una respuesta o redirigir a otra ruta.

Hay que entender que cuando se recibe una petici贸n, se comienzan a ejecutar los middlewares en el orden en el que se han definido. Si todos los middlewares pasan, la ruta se ejecuta. Si alguno de los middlewares falla, se devuelve una respuesta o se redirige a otra ruta.

En nuestro caso, vamos a comprobar si el usuario est谩 subscrito a un plan de pago. Si no lo est谩, vamos a redirigirlo a la p谩gina de suscripci贸n. Para ello, vamos a suponer que el usuario tiene un campo `subscribed` en la tabla `users`.

```php
class Subscribed
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        if ($request->user()->subscribed) {
            return $next($request);
        }

				return abort(403)
    }
}
```

Una vez que el middleware est谩 creado, debemos registrarlo en el archivo `bootstrap/app.php`. Para ello, a帽adimos la siguiente l铆nea al array de middlewares:

```php
return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // Register the middleware
        $middleware->registerMiddleware(Subscribed::class);
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })->create();
```

### Asignar un Middleware a una Ruta

Una vez que hemos creado nuestro middleware, podemos asignarlo a una ruta. Para ello, simplemente a帽adimos el middleware al array de middlewares en la definici贸n de la ruta.

```php
Route::get('/notes',[NoteContoller::class, 'index'])->middleware('subscribed');
```

De esta forma, si el usuario quisiera acceder al listado de notas, se validar铆a si est谩 subscrito a un plan de pago. Si no lo est谩, en este mostrar铆a un error 403.


## Proteger ruta de notas

En nuestra aplicaci贸n a煤n la 煤nica ruta que tenemos es la de la lista de notas. Vamos a proteger esta ruta para que solo los usuarios autenticados puedan acceder a ella.

De forma predeterminada, Laravel nos proporciona un middleware llamado `auth`,que se encarga de verificar si el usuario est谩 autenticado, y si no lo est谩, redirige al usuario a la p谩gina de inicio de sesi贸n.

Para ello, vamos a agrupar todas las rutas de notas en un grupo, y asignar el middleware `auth` a ese grupo.

```php
Route::middleware('auth')->group(function () {
    Route::get('/notes',[NoteContoller::class, 'index']);
});
```

Si ahora intentamos acceder a las notas, si NO estamos autenticados, Boom! Laravel nos lanzar谩 un error!!. La ruta `/login` no existe, pero c贸mo que no existe, si yo tengo una ruta definida `/login` en el archivo `web.php`? <br>

Pues realmente el motivo, es porque Laravel esta buscando una ruta de nombre `login`, y no la encuentra. Para solucionar esto, vamos a a帽adir nombre a la ruta de login.

```php
Route::get('/login', [SessionController::class, 'create'])->name('login'); 
```

Y ahora si volvemos a probar, ahora nos redirige a la p谩gina de inicio de sesi贸n. Perfecto! 


## Conclusi贸n

En esta lecci贸n hemos visto c贸mo proteger las rutas de nuestra aplicaci贸n, para que solo puedan ser accedidas por usuarios autenticados. Existen otras muchas formas de proteger nuestra aplicaci贸n, como por ejemplo, utilizando `Policies` o `Gates`, pero esto es algo que por ahora no es necesario.

---

> 癸 Alguna duda? puedes ver el siguiente [video](https://laracasts.com/series/30-days-to-learn-laravel-11/episodes/20) que explica estos pasos con m谩s detalle.
