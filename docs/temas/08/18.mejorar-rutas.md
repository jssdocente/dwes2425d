# 18. Mejorar rutas

En esta 18¬™ lecci√≥n, vamos a ver c√≥mo podemos mejorar nuestras rutas, utilizando distintas opciones que nos da Laravel, como controladores, rutas con nombres, etc ..

### Recursos

- [6 Tips to Organize Routes](https://laravel-news.com/laravel-route-organization-tips)


## T√©cnicas para mejorar las rutas

Existen diferentes opciones en laravel para mejorar nuestras rutas, dependiendo de la complejidad de nuestra aplicaci√≥n, podemos utilizar una u otra.

Las veremos de m√°s sencillas a m√°s complejas.

### 1. Route Model Binding

Laravel nos permite obtener un modelo directamente desde la ruta, sin tener que hacer la consulta manualmente. Esto se llama `Route Model Binding`.

> ü™ß Para m√°s info consulta la [documentaci√≥n de Laravel](https://laravel.com/docs/11.x/folio#route-model-binding) sobre este tema.

Para aplicar esta t√©nnica, el par√°metro `wilcard` de la ruta debe coincidir con el nombre de un modelo, y Laravel sabr√° c√∫al es el campo ID de ese m√≥delo y por tanto, c√≥mo debe hacer la consulta.

En nuestro fichero de rutas `web.php`, vamos a aplicar esta t√©cnica para visualizar una ruta:

```php
//show
Route::get('/notes/{note}', function (Note $note) {
    //{note} es el par√°metro wildcard que coincide con el nombre del modelo. La funci√≥n recibe el modelo directamente.
    return view('notes.show', ['note' => $note]);
});
```

Tambi√©n puede ocurrir, que queramos buscar por otro campo distinto al ID. En este caso, debemos sobreescribir el m√©todo `getRouteKeyName` en el modelo. Imaginemos que nuestra nota tiene un campo √∫nico, texto, llamado `slug`. Un slug es una cadena de texto que identifica de forma √∫nica una nota, ejemplo: `mi-nota`.

```php
class Note extends Model
{
    public function getRouteKeyName()
    {
        return 'slug';
    }
}
```

Otra opci√≥n m√°s directa, es indicar el nombre del campo en la ruta:

```php
Route::get('/notes/{note:slug}', function (Note $note) {
    //Laravel buscar√° la nota por el campo slug en lugar de por el campo id
    return view('notes.show', ['note' => $note]);
});
```

De esta forma, Laravel buscar√° la nota por el campo `slug` en lugar de por el campo `id`.

Tambi√©n vamos a aplicar esto, a la ruta de edici√≥n, y a la de Update y Delete.

```php
//edit
Route::get('/notes/{note}/edit', function (Note $note) {
    return view('notes.edit', ['note' => $note]);
});
```

```php
//update
Route::put('/notes/{note}', function (Note $note) {
    //Validar los datos
    request()->validate([
        'title' => 'required',
        'body' => 'required|max:255'
    ]);

    //Actualizar la nota
    $note->update([
        'title' => request('title'),
        'body' => request('body')
    ]);

    return redirect('/notes');
});

//delete
Route::delete('/notes/{note}', function (Note $note) {
    $note->delete();
    return redirect('/notes');
});
```

> üí° En caso de que no encuentre la nota, mostrar√° un error 404 NotFound.

Aplica estos cambios y comprueba que todo sigue funcionando correctamente.


### 2. Controladores como Clases

Si nuestra aplicaci√≥n es m√°s compleja, y tenemos muchas rutas, y las rutas requieren de l√≥gica m√°s compleja, es recomendable encapsular esa l√≥gica en un controlador.

Los controladores son clases, que contendr√°n un m√©todo para cada acci√≥n que queramos realizar. 

Van a existir 2 tipos de controlares principalemente:

- Controladores de recursos (Que contienen la l√≥gica para las 7 acciones CRUD)
- Controladores invocables (que contienen un √∫nico m√©todo `__invoke`, para una sola acci√≥n)

Para crear un controlador, lo podemos hacer manualmente, o utilizando artisan:

```bash
php artisan make:controller NoteController
```

o, la forma recomendada, es como se muestra en el siguiente video.

![make controller](./img/21.make-controller-1.gif)

Como se muestra en el video, vamos a crear un controlador de recursos, que contendr√° la l√≥gica para todas las acciones CRUD. El nuevo controlador estar√° ubicado en la carpeta `app/Http/Controllers`.

Si lo revisamos, comprobaremos que es una clase que contiene los siguientes m√©todos:

- public function index()
- public function create()
- public function store(Request $request)
- public function show(Note $note)
- public function edit(Note $note)
- public function update(Request $request, Note $note)
- public function destroy(Note $note)

> üí° Al asociar un modelo en la creaci√≥n del controlador, Laravel automaticamente indica el tipo del modelo en los diferentes m√©todos. üëåüèº

Ahora vamos a convertir nuestras rutas en rutas de recursos, que apuntar√°n a los m√©todos del controlador. Para ello, podemos utilizar 2 diferentes sintaxis, si tenemos un controlador con todas las acciones CRUD, o existen algunas acciones no disponibles.

1. Opci√≥n 1: Todas las acciones CRUD

  Laraval se encargar√° de instanciar el controlador, y de llamar al m√©todo correspondiente. Recuerda Laravel funciona por convenci√≥n sobre configuraci√≥n.

  ```php
  Route::resource('notes', NoteController::class);
  ```
2. Opci√≥n 2: Algunas acciones no disponibles

  En este caso, debemos indicar las acciones que no queremos que se realicen, y Laravel no crear√° las rutas para esas acciones.

  ```php
  Route::resource('notes', NoteController::class)->except(['destroy']);
  ```
  
  o si existen solo algunas acciones que queremos que se realicen:

  ```php
  Route::resource('notes', NoteController::class)->only(['index', 'show']);
  ```
3. Opci√≥n 3: Controladores invocables

  Utilizar una ruta por acci√≥n, e indicar el controlador y el m√©todo a ejecutar.

  ```php
  Route::get('/notes', [NoteController::class, 'index']);
  ```


En nuestro caso, ya que tenemos todas las acciones CRUD, vamos a utilizar la opci√≥n 1.


**Convertir las rutas en rutas de recursos**

Con esta opci√≥n, ahora en el fichero de rutas `web.php`, todo se hace mucho m√°s simple.

Comenta las rutas que ten√≠amos antes, y a√±ade la siguiente l√≠nea:

```php
//NOTAS
Route::resource('notes', NoteController::class);

// ** NOTAS forma anterior **
//index
//Route::get('/notes', function () {
//    return view('notes.index', ['items' => Note::all()]);
//});

//create
//Route::get('/notes/create', function ()  {
//    return view('notes.create', []);
//});

//edit
//Route::get('/notes/{note}/edit', function (Note $note) {
//    return view('notes.edit', ['note' => $note]);
//});

//show
//Route::get('/notes/{note}', function (Note $note) {
//    return view('notes.show', ['note' => $note]);
//});

//store
//Route::post('/notes', function ()  {
//
//    //2. Validar los datos
//    request()->validate([
//        'title' => ['required'],
//        'body' => ['required', 'max:255']
//    ]);
//
//    //3. Crear la nota
//    Note::create([
//        'title' => request('title'),
//        'body' => request('body'),
//        'user_id' => 1  //por ahora lo dejamos fijo
//    ]);
//
//    //4. Retornar la vista de la lista de notas
//    return redirect('/notes');
//});

//update
//Route::patch('/notes/{note}', function (Note $note)  {
//
//  //2. Validar los datos
//  request()->validate([
//    'title' => ['required', 'min:5'],
//    'body' => ['required', 'max:255']
//  ]);
//
//  //3. Autorizar (pr√≥ximamente)
//
//  //4. Obtener y actualizar la nota
//
//  $note->update([
//    'title' => request('title'),
//    'body' => request('body'),
//  ]);
//
//  //5. Retornar la vista de la lista de notas
//  return redirect('/notes');
//
//});

//destroy
//Route::delete('/notes/{note}', function (Note $note)  {
//
//  //2. Obtener nota nota, y si no existe, lanzar un error 404
//
//
//  //3. Autorizar (pr√≥ximamente)
//
//  //4. Eliminar la nota
//  $note->delete();
//
//  //5. Redireccionar a la lista de notas
//  return redirect('/notes');
//});
```

Y el controller `NoteController` quedar√≠a as√≠:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Note;
use Illuminate\Http\Request;

class NoteController extends Controller {
  /**
   * Display a listing of the resource.
   */
  public function index() {
    return view('notes.index', ['items' => Note::all()]);
  }

  /**
   * Store a newly created resource in storage.
   */
  public function store(Request $request) {
    //2. Validar los datos
    request()->validate([
      'title' => ['required'],
      'body' => ['required', 'max:255']
    ]);

    //3. Crear la nota
    Note::create([
      'title' => request('title'),
      'body' => request('body'),
      'user_id' => 1  //por ahora lo dejamos fijo
    ]);

    //4. Retornar la vista de la lista de notas
    return redirect('/notes');
  }

  /**
   * Show the form for creating a new resource.
   */
  public function create() {
    return view('notes.create', []);
  }

  /**
   * Display the specified resource.
   */
  public function show(Note $note) {
    return view('notes.show', ['note' => $note]);
  }

  /**
   * Show the form for editing the specified resource.
   */
  public function edit(Note $note) {
    return view('notes.edit', ['note' => $note]);
  }

  /**
   * Update the specified resource in storage.
   */
  public function update(Request $request, Note $note) {
    //2. Validar los datos
    request()->validate([
      'title' => ['required', 'min:5'],
      'body' => ['required', 'max:255']
    ]);

    //3. Autorizar (pr√≥ximamente)

    //4. Obtener y actualizar la nota

    $note->update([
      'title' => request('title'),
      'body' => request('body'),
    ]);

    //5. Retornar la vista de la lista de notas
    return redirect('/notes');
  }

  /**
   * Remove the specified resource from storage.
   */
  public function destroy(Note $note) {
    //3. Autorizar (pr√≥ximamente)

    //4. Eliminar la nota
    $note->delete();

    //5. Redireccionar a la lista de notas
    return redirect('/notes');

  }
}
```

Haz estos cambios, y comprueba que todo sigue funcionando correctamente.

*La pregunta interesante que te estar√°s preguntando, ¬øporqu√© sigue todo funcionando si las rutas han cambiado? La respuesta es que Laravel sigue funcionando por convenci√≥n sobre configuraci√≥n, y c√≥mo nuestro c√≥digo segu√≠a las convecciones de Laravel, todo sigue funcionando correctamente.*

Si por alg√∫n motivo no hubieramos seguido las convecciones, a√∫n podr√≠amos utilizar un controlador de recursos, pero tendr√≠amos que indicar las rutas manualmente.

De esa forma, quedar√≠a as√≠:

```php
//NOTAS
Route::get('/notes', [NoteController::class, 'index']);
Route::get('/notes/create', [NoteController::class, 'create']);
Route::post('/notes', [NoteController::class, 'store']);
Route::get('/notes/{note}', [NoteController::class, 'show']);
Route::get('/notes/{note}/edit', [NoteController::class, 'edit']);
Route::patch('/notes/{note}', [NoteController::class, 'update']);
Route::delete('/notes/{note}', [NoteController::class, 'destroy']);
```

En ambos casos, al utilizar un controlador, el fichero de rutas `web.php` queda mucho m√°s limpio y f√°cil de leer.


**Listar las rutas**

Cuando una aplicaci√≥n crece, es posible que tengamos muchas rutas, y no sepamos exactamente cu√°les son. Para listar todas las rutas de nuestra aplicaci√≥n, podemos utilizar el comando artisan `route:list`.

```bash
php artisan route:list
```

En nuestro caso el resultado ser√≠a el siguiente:

```bash
+--------+-----------+------------------------+-----------------+-------------------------------------------------+------------+
| Domain | Method    | URI                    | Name            | Action                                          | Middleware |
+--------+-----------+------------------------+-----------------+-------------------------------------------------+------------+
|        | GET|HEAD  | /                      |                 | Closure                                          | web        |
|        | GET|HEAD  | /about                 |                 | Closure                                          | web        |
|        | GET|HEAD  | /contact               |                 | Closure                                          | web        |
|        | GET|HEAD  | notes                  | notes.index     | App\Http\Controllers\NoteController@index        | web        |
|        | POST      | notes                  | notes.store     | App\Http\Controllers\NoteController@store        | web        |
|        | GET|HEAD  | notes/create           | notes.create    | App\Http\Controllers\NoteController@create       | web        |
|        | GET|HEAD  | notes/{note}           | notes.show      | App\Http\Controllers\NoteController@show         | web        |
|        | PUT|PATCH | notes/{note}           | notes.update    | App\Http\Controllers\NoteController@update       | web        |
|        | DELETE    | notes/{note}           | notes.destroy   | App\Http\Controllers\NoteController@destroy      | web        |
|        | GET|HEAD  | notes/{note}/edit      | notes.edit      | App\Http\Controllers\NoteController@edit         | web        |
+--------+-----------+------------------------+-----------------+-------------------------------------------------+------------+
```

Si no queremos ver rutas de terceros, podemos utilizar la opci√≥n `--except-vendor`.:

```bash
php artisan route:list -except-vendor
```

### 3. Rutas con nombre

Las rutas con nombre, nos permiten nombrar una ruta, y utilizar ese nombre en lugar de la URL en nuestros enlaces, redirecciones, etc. Esto es muy √∫til, ya que nos permiten nombrar a la ruta con un nombre m√°s descriptivo, y si en alg√∫n momento cambiamos la URL, no tendremos que cambiar en todos los lugares donde se utiliza.

Para nombrar una ruta, simplemente a√±adimos el m√©todo `name` a la definici√≥n de la ruta.

```php
Route::get('/about', function () {
    return view('about');
})->name('about');

Route::get('/contact', function () {
    return view('contact');
})->name('contact');

Route::get('/notes', [NoteController::class, 'index'])->name('notes.index');
Route::get('/notes/create', [NoteController::class, 'create'])->name('notes.create');
Route::post('/notes', [NoteController::class, 'store'])->name('notes.store');
Route::get('/notes/{note}', [NoteController::class, 'show'])->name('notes.show');
Route::get('/notes/{note}/edit', [NoteController::class, 'edit'])->name('notes.edit');
Route::put('/notes/{note}', [NoteController::class, 'update'])->name('notes.update');
Route::delete('/notes/{note}', [NoteController::class, 'destroy'])->name('notes.destroy');

//Para un ruta tipo resource
Route::resource('notes', NoteController::class)->names([
    'index' => 'notes.index',
    'create' => 'notes.create',
    'store' => 'notes.store',
    'show' => 'notes.show',
    'edit' => 'notes.edit',
    'update' => 'notes.update',
    'destroy' => 'notes.destroy'
]);
```

Ahora podemos utilizar esta nomenclatura en nuestros enlaces, redirecciones, etc.

```php
<a href="{{ route('about') }}">About</a>
<a href="{{ route('contact') }}">Contact</a>
```

y tambi√©n en las redirecciones:

```php
return redirect()->route('notes.index');
```

y para saber si una ruta es la actual, podemos utilizar el m√©todo `is`:

```php
request()->routeIs('notes.index');
```

Como podemos comprobar, las rutas con nombre, nos permiten tener un c√≥digo m√°s limpio y f√°cil de leer.

### 4. Agrupar las rutas

Si tenemos rutas que comparten un prefijo, por ejemplo, en nuestras rutas de notas, todas empiezan por `/notes`, podemos agruparlas, y de esa forma, no tener que repetir ese prefijo en todas las rutas.

Para agrupar las rutas, utilizamos el m√©todo `Route::controller`, y dentro de ese m√©todo, definimos las rutas que queremos agrupar.

```php
Route::controller('notes')->group(function () {
    //El controlador ya no es necesario indicarlo.
    Route::get('/notes','index')->name('notes.index');
    Route::get('/notes/create','create')->name('notes.create');
    Route::post('/notes','store')->name('notes.store');
    Route::get('/notes/{note}','show')->name('notes.show');
    Route::get('/notes/{note}/edit','edit')->name('notes.edit');
    Route::put('/notes/{note}','update')->name('notes.update');
    Route::delete('/notes/{note}','destroy')->name('notes.destroy');
});
```

Tambi√©n podemos utilizar el m√©todo `prefix` para indicar un prefijo com√∫n a todas las rutas, y de esa forma, no tener que repetirlo en todas las rutas:

```php
Route::prefix('notes')->group(function () {
  Route::get('/', [NoteController::class, 'index'])->name('notes.index');
  Route::get('/create', [NoteController::class, 'create'])->name('notes.create');
  Route::post('/', [NoteController::class, 'store'])->name('notes.store');
  Route::get('/{note}', [NoteController::class, 'show'])->name('notes.show');
  Route::get('/{note}/edit', [NoteController::class, 'edit'])->name('notes.edit');
  Route::put('/{note}', [NoteController::class, 'update'])->name('notes.update');
  Route::delete('/{note}', [NoteController::class, 'destroy'])->name('notes.destroy');
});
```

Existen otras formas m√°s avanzadas de agrupaci√≥n de rutas, para m√°s informaci√≥n consulta el siguiente art√≠culo: [6 Tips to Organize Routes](https://laravel-news.com/laravel-route-organization-tips)


Con estas t√©cnicas, hemos mejorado nuestras rutas, y hemos hecho nuestro c√≥digo m√°s limpio y f√°cil de leer.

üèÅ ¬°Enhorabuena! ¬°Has completado la lecci√≥n! ¬°Vamos a la siguiente!

---

> ‚ÑπÔ∏è Alguna duda? puedes ver el siguiente [video](https://laracasts.com/series/30-days-to-learn-laravel-11/episodes/19) que explica estos pasos con m√°s detalle.